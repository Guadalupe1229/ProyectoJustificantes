name: CodeQL Scan + Auto Issues

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  codeql-analysis:
    name: Run CodeQL analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3

  create-issues-from-codeql:
    name: Create Issues from Alerts
    runs-on: ubuntu-latest
    needs: codeql-analysis

    steps:
      - uses: actions/checkout@v4

      - name: Wait for alerts to appear
        run: sleep 15

      - name: Create GitHub Issues from alerts
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner: owner,
              repo: repo,
              state: "open",
              per_page: 100
            });

            const existingIssues = await github.rest.issues.listForRepo({
              owner: owner,
              repo: repo,
              labels: "code-scanning",
              state: "open"
            });

            function exists(title) {
              return existingIssues.data.some(
                issue => issue.title.trim().toLowerCase() === title.trim().toLowerCase()
              );
            }

            for (const alert of alerts.data) {
              const rule = alert.rule && alert.rule.id ? alert.rule.id : "Unknown";
              const sev  = alert.rule && alert.rule.severity ? alert.rule.severity : "unknown";
              const tool = alert.tool && alert.tool.name ? alert.tool.name : "CodeQL";

              const loc  = alert.most_recent_instance && alert.most_recent_instance.location;
              const file = loc && loc.path ? loc.path : "N/A";
              const line = loc && loc.start_line ? loc.start_line : "N/A";

              const title = "CodeQL Alert: " + rule + " (" + sev + ") at " + file + ":" + line;

              if (exists(title)) {
                continue;
              }

              const body =
                "CodeQL Alert\n\n" +
                "Rule: " + rule + "\n" +
                "Severity: " + sev + "\n" +
                "Tool: " + tool + "\n" +
                "File: " + file + "\n" +
                "Line: " + line + "\n\n" +
                "Raw alert JSON:\n" +
                JSON.stringify(alert, null, 2);

              await github.rest.issues.create({
                owner: owner,
                repo: repo,
                title: title,
                body: body,
                labels: ["code-scanning", "security", "automated"]
              });
            }
