name: CodeQL Scan + Auto Issues

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  codeql-analysis:
    name: Run CodeQL analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3

  create-issues-from-codeql:
    name: Create Issues from Alerts
    runs-on: ubuntu-latest
    needs: codeql-analysis

    steps:
      - uses: actions/checkout@v4

      - name: Wait for alerts to appear
        run: sleep 15

      - name: Create GitHub Issues from alerts
        uses: actions/github-script@v6
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            console.log("Getting CodeQL alerts...");
            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner,
              repo,
              state: "open",
              per_page: 100
            });

            console.log(`Total alerts found: ${alerts.data.length}`);

            const existingIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: "code-scanning",
              state: "open"
            });

            function alreadyExists(title) {
              return existingIssues.data.some(
                issue => issue.title.trim().toLowerCase() === title.trim().toLowerCase()
              );
            }

            for (const alert of alerts.data) {

              const rule = alert.rule?.id || "Unknown Rule";
              const sev  = alert.rule?.severity || "unknown";
              const tool = alert.tool?.name || "CodeQL";

              const file = alert.most_recent_instance?.location?.path || "N/A";
              const line = alert.most_recent_instance?.location?.start_line || "N/A";

              const title = `CodeQL Alert: ${rule} (${sev.toUpperCase()}) at ${file}:${line}`;

              if (alreadyExists(title)) {
                console.log(`Issue already exists: ${title}`);
                continue;
              }

              const body = `
### CodeQL Alert Report

**Rule:** ${rule}  
**Severity:** ${sev}  
**Tool:** ${tool}  
**File:** ${file}  
**Line:** ${line}  

---

### Full Alert JSON
\`\`\`json
${JSON.stringify(alert, null, 2)}
\`\`\`
              `;

              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ["code-scanning", "security", "automated"]
              });

              console.log(`Created new Issue: ${title}`);
            }
