name: Crear issues automáticos desde CodeQL

on:
  schedule:
    - cron: "0 */6 * * *"   # cada 6 horas
  workflow_dispatch:       # permite ejecutarlo manualmente

jobs:
  create_issues:
    runs-on: ubuntu-latest

    permissions:
      security-events: read
      issues: write
      contents: read

    steps:
      - name: Obtener alertas de CodeQL y crear issues
        uses: actions/github-script@v7
        with:
          script: |
            const alerts = await github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            for (const alert of alerts.data) {
              const file = alert.most_recent_instance?.location?.path || "Archivo no detectado";
              const line = alert.most_recent_instance?.location?.startLine || "Desconocido";

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `CodeQL: ${alert.rule.description} en ${file}`,
                body: `
**Severidad:** ${alert.rule.severity}
**Archivo:** ${file}
**Línea:** ${line}
**Regla:** ${alert.rule.id}

**Descripción del problema:**  
${alert.rule.description}

**Sugerencia de corrección:**  
Revisar el archivo indicado y aplicar las recomendaciones del motor CodeQL para reforzar seguridad.
`,
                labels: ["security", "codeql", alert.rule.severity]
              });
            }
